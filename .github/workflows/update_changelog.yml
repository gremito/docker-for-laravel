name: Update CHANGELOG on PR

on:
  pull_request:
    types: [opened]
    paths:
      - 'web/**'
  workflow_dispatch:

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if changes exist in specified paths
        id: check_changes
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main)
          echo "Changed files: $CHANGED_FILES"
          echo "::set-output name=changed_files::$CHANGED_FILES"
        shell: bash

      - name: Update CHANGELOG
        if: env.continue != 'false'
        id: update_changelog
        run: |
          cd ./web
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          CHANGELOG="./CHANGELOG.md"
          DATE=$(date +'%Y-%m-%d')

          if [ ! -e $CHANGELOG ]; then
            touch $CHANGELOG
          fi

          # Check if the date already exists in the CHANGELOG
          LINE_NUM=$(grep -n "^## $DATE" $CHANGELOG | cut -d: -f1)

          if [ -n "$LINE_NUM" ]; then
            # Insert the PR information below the found date line
            sed -i "$((LINE_NUM + 1)) i\- $PR_TITLE (#$PR_NUMBER)" $CHANGELOG
          else
            # Add the date and PR information at the end of the file
            echo -e "## $DATE\n- $PR_TITLE (#$PR_NUMBER)" >> $CHANGELOG
          fi
          cd ../

      - name: Commit and Push CHANGELOG
        if: env.continue != 'false'
        run: |
          git add ${{ env.CHANGELOG }}
          git commit -m "Update CHANGELOG for PR #${{ github.event.pull_request.number }} in ${{ env.PROJECT }}"
          git push origin HEAD:refs/pull/${{ github.event.pull_request.number }}/head
